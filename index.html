<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - The Echo Chamber</title>
    
    <!-- ========================================== -->
    <!-- ðŸŽ¯ INSTANT LOADING GATE - RENDERS BEFORE JS -->
    <!-- ========================================== -->
    <style>
        /* Instant loader styles - inline for zero delay */
        #instant-gate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            transition: opacity 0.4s ease;
        }
        
        #instant-gate.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .gate-spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: gate-spin 0.8s linear infinite;
        }
        
        @keyframes gate-spin {
            to { transform: rotate(360deg); }
        }
        
        .gate-title {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-top: 30px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .gate-message {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            margin-top: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            animation: gate-pulse 2s ease-in-out infinite;
        }
        
        @keyframes gate-pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        .gate-subtext {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            margin-top: 8px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
    </style>
</head>
<body>
    <!-- ========================================== -->
    <!-- INSTANT GATE: Shows IMMEDIATELY (no JS wait) -->
    <!-- ========================================== -->
    <div id="instant-gate">
        <div class="gate-spinner"></div>
        <div class="gate-title">THE BLACK ZENITH</div>
        <div class="gate-message" id="gate-status">Initializing...</div>
        <div class="gate-subtext" id="gate-subtext"></div>
    </div>
    
    <!-- ========================================== -->
    <!-- ðŸ”’ TOKEN GATE - EXECUTES AFTER DOM READY -->
    <!-- ========================================== -->
    <script>
    (function() {
        'use strict';
        
        const API_BASE_URL = "https://api-gateway-96c7cdb8.kiaraoct34.workers.dev/api/v1";
        const gateStatus = document.getElementById('gate-status');
        const gateSubtext = document.getElementById('gate-subtext');
        
        // Update status message
        function updateStatus(message, subtext = '') {
            gateStatus.textContent = message;
            gateSubtext.textContent = subtext;
        }
        
        // Remove gate with fade animation
        function removeGate() {
            const gate = document.getElementById('instant-gate');
            gate.classList.add('fade-out');
            setTimeout(() => gate.remove(), 400);
        }
        
        // ====================================
        // RATE LIMITING - Prevent brute force
        // ====================================
        function checkRateLimit() {
            const failedAttempts = parseInt(localStorage.getItem('failed_auth_attempts') || '0', 10);
            const lastAttempt = parseInt(localStorage.getItem('last_failed_attempt') || '0', 10);
            const timeSince = Date.now() - lastAttempt;
            const ONE_HOUR = 3600000;
            
            if (failedAttempts >= 5 && timeSince < ONE_HOUR) {
                const minutesRemaining = Math.ceil((ONE_HOUR - timeSince) / 60000);
                show404(true, minutesRemaining);
                return false;
            }
            
            return true;
        }
        
        function recordFailedAttempt() {
            const current = parseInt(localStorage.getItem('failed_auth_attempts') || '0', 10);
            localStorage.setItem('failed_auth_attempts', (current + 1).toString());
            localStorage.setItem('last_failed_attempt', Date.now().toString());
        }
        
        function clearFailedAttempts() {
            localStorage.removeItem('failed_auth_attempts');
            localStorage.removeItem('last_failed_attempt');
        }
        
        // ====================================
        // STEALTH 404 PAGE
        // ====================================
        function show404(rateLimited = false, minutesRemaining = 0) {
            const message = rateLimited 
                ? `<p style="color: #586069; font-size: 14px;">Too many requests. Please try again in ${minutesRemaining} minute${minutesRemaining > 1 ? 's' : ''}.</p>`
                : '<p style="color: #586069; font-size: 14px;">This is not the web page you are looking for.</p>';
            
            document.open();
            document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>404 - Page Not Found</title>
                    <style>
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                            margin: 0;
                            padding: 0;
                            background: #fff;
                        }
                        .container { 
                            max-width: 600px; 
                            margin: 0 auto; 
                            padding: 100px 40px; 
                            text-align: center; 
                        }
                        h1 { 
                            font-size: 48px; 
                            margin-bottom: 10px;
                            font-weight: 300;
                            color: #24292e;
                        }
                        p { 
                            color: #586069; 
                            font-size: 16px;
                            line-height: 1.5;
                        }
                        .logo {
                            width: 32px;
                            height: 32px;
                            margin-bottom: 20px;
                            opacity: 0.5;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <svg class="logo" height="32" viewBox="0 0 16 16" width="32" fill="#24292e">
                            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                        </svg>
                        <h1>404</h1>
                        ${message}
                    </div>
                </body>
                </html>
            `);
            document.close();
        }
        
        // Check rate limit first
        if (!checkRateLimit()) {
            return;
        }
        
        // Check if there's an access token in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('access_token');
        
        // If no token in URL, check if user already has a valid JWT session
        if (!accessToken) {
            updateStatus('Checking session...', 'Please wait');
            
            const existingJWT = localStorage.getItem('lustroom_jwt');
            const obtainedAt = parseInt(localStorage.getItem('lustroom_jwt_obtained_at'), 10);
            const expiresIn = parseInt(localStorage.getItem('lustroom_jwt_expires_in'), 10);
            
            // If JWT exists and is still valid, redirect to main app
            if (existingJWT && obtainedAt && expiresIn) {
                const nowInSeconds = Math.floor(Date.now() / 1000);
                const isStillValid = (obtainedAt + expiresIn - 60) > nowInSeconds;
                
                if (isStillValid) {
                    updateStatus('Session found!', 'Redirecting...');
                    setTimeout(() => {
                        window.location.href = 'links.html';
                    }, 300);
                    return;
                }
            }
            
            // No valid session â†’ Render login/forgot password page
            updateStatus('Loading login...', '');
            setTimeout(() => {
                removeGate();
                renderAuthPage();
            }, 500);
            return;
        }
        
        // ====================================
        // TOKEN VALIDATION FLOW
        // ====================================
        
        updateStatus('Waking up server...', 'This may take up to 30 seconds on first load');
        
        // Validate token with backend
        fetch(`${API_BASE_URL}/auth/validate-token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token: accessToken })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Token validation failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success' && data.access_token) {
                updateStatus('Authenticated!', 'Loading profile...');
                
                localStorage.setItem('lustroom_jwt', data.access_token);
                localStorage.setItem('lustroom_jwt_expires_in', data.expires_in);
                localStorage.setItem('lustroom_jwt_obtained_at', Math.floor(Date.now() / 1000));
                localStorage.setItem('user_info', JSON.stringify(data.user_info));
                
                return fetch(`${API_BASE_URL}/profile`, {
                    headers: { 'Authorization': `Bearer ${data.access_token}` }
                });
            } else {
                throw new Error('Invalid response from server');
            }
        })
        .then(response => response.json())
        .then(profileData => {
            if (profileData.status === 'success') {
                localStorage.setItem('user_subscriptions', JSON.stringify(profileData.subscriptions || []));
                
                if (profileData.announcements) {
                    localStorage.setItem('global_announcements', JSON.stringify(profileData.announcements));
                } else {
                    localStorage.removeItem('global_announcements');
                }
                
                clearFailedAttempts();
                updateStatus('Success!', 'Entering...');
                setTimeout(() => {
                    window.location.href = 'links.html';
                }, 300);
            } else {
                throw new Error('Failed to load user profile');
            }
        })
        .catch(error => {
            console.error('Token validation error:', error);
            recordFailedAttempt();
            updateStatus('Authentication failed', 'Loading login...');
            setTimeout(() => {
                removeGate();
                renderAuthPage();
            }, 800);
        });
        
        // ====================================
        // LOGIN & FORGOT PASSWORD PAGE
        // ====================================
        function renderAuthPage() {
            document.open();
            document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Login - The Echo Chamber</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            min-height: 100vh; display: flex; align-items: center; justify-content: center;
                            padding: 20px;
                            animation: fadeIn 0.5s ease;
                        }
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        .container {
                            background: white; border-radius: 16px;
                            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                            max-width: 480px; width: 100%; padding: 40px;
                        }
                        h1 { 
                            font-size: 28px; color: #2c3e50; margin-bottom: 10px; 
                            font-weight: 600; text-align: center; 
                        }
                        .subtitle { 
                            color: #7f8c8d; font-size: 15px; margin-bottom: 35px; 
                            text-align: center; 
                        }
                        .form-toggle {
                            display: flex; gap: 10px; margin-bottom: 30px;
                            border-bottom: 2px solid #e0e0e0;
                        }
                        .toggle-btn {
                            flex: 1; padding: 12px; background: none; border: none;
                            border-bottom: 3px solid transparent; cursor: pointer;
                            font-size: 15px; font-weight: 600; color: #7f8c8d;
                            transition: all 0.3s;
                        }
                        .toggle-btn.active {
                            color: #667eea; border-bottom-color: #667eea;
                        }
                        .form-panel { display: none; animation: formFadeIn 0.3s; }
                        .form-panel.active { display: block; }
                        @keyframes formFadeIn { from { opacity: 0; } to { opacity: 1; } }
                        .input-group { margin-bottom: 20px; }
                        label { 
                            display: block; margin-bottom: 8px; color: #34495e; 
                            font-size: 14px; font-weight: 500; 
                        }
                        input {
                            width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0;
                            border-radius: 8px; font-size: 16px; transition: all 0.3s;
                            font-family: inherit;
                        }
                        input:focus { 
                            outline: none; border-color: #667eea; 
                            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
                        }
                        button {
                            width: 100%; padding: 16px; 
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; border: none; border-radius: 8px;
                            font-size: 16px; font-weight: 600; cursor: pointer;
                            transition: transform 0.2s, box-shadow 0.2s;
                        }
                        button:hover:not(:disabled) { 
                            transform: translateY(-2px); 
                            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); 
                        }
                        button:active:not(:disabled) { transform: translateY(0); }
                        button:disabled { opacity: 0.6; cursor: not-allowed; }
                        .message {
                            margin-top: 15px; padding: 14px; border-radius: 8px;
                            font-size: 14px; display: none; animation: slideIn 0.3s;
                        }
                        .message.error { 
                            background: #fee; color: #c33; border: 1px solid #fcc; 
                        }
                        .message.success { 
                            background: #efe; color: #393; border: 1px solid #cfc; 
                        }
                        .loading {
                            display: inline-block; width: 18px; height: 18px;
                            border: 3px solid rgba(255, 255, 255, 0.3);
                            border-top-color: white; border-radius: 50%;
                            animation: spin 0.8s linear infinite;
                        }
                        @keyframes spin { to { transform: rotate(360deg); } }
                        @keyframes slideIn { 
                            from { opacity: 0; transform: translateY(-10px); } 
                            to { opacity: 1; transform: translateY(0); } 
                        }
                        .help-text {
                            margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;
                            font-size: 13px; color: #7f8c8d; text-align: center;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>Welcome Back</h1>
                        <p class="subtitle">Sign in to your account</p>
                        
                        <div class="form-toggle">
                            <button class="toggle-btn active" data-panel="login">Login</button>
                            <button class="toggle-btn" data-panel="forgot">Forgot Password</button>
                        </div>
                        
                        <div id="login-panel" class="form-panel active">
                            <form id="loginForm">
                                <div class="input-group">
                                    <label for="login-email">Email</label>
                                    <input 
                                        type="email" 
                                        id="login-email" 
                                        name="email"
                                        placeholder="your.email@example.com"
                                        required
                                        autofocus
                                    >
                                </div>
                                
                                <div class="input-group">
                                    <label for="login-password">Password</label>
                                    <input 
                                        type="password" 
                                        id="login-password" 
                                        name="password"
                                        placeholder="Enter your password"
                                        required
                                    >
                                </div>
                                
                                <button type="submit" id="loginBtn">
                                    Log In
                                </button>
                                
                                <div id="login-message" class="message"></div>
                            </form>
                        </div>
                        
                        <div id="forgot-panel" class="form-panel">
                            <form id="forgotForm">
                                <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px; line-height: 1.5;">
                                    Enter your email address and we'll send you a link to reset your password.
                                </p>
                                
                                <div class="input-group">
                                    <label for="forgot-email">Email</label>
                                    <input 
                                        type="email" 
                                        id="forgot-email" 
                                        name="email"
                                        placeholder="your.email@example.com"
                                        required
                                    >
                                </div>
                                
                                <button type="submit" id="forgotBtn">
                                    Send Reset Link
                                </button>
                                
                                <div id="forgot-message" class="message"></div>
                            </form>
                        </div>
                        
                        <div class="help-text">
                            <p>Need help? Contact support.</p>
                        </div>
                    </div>
                    
                    <script>
                        const API_BASE_URL = "https://api-gateway-96c7cdb8.kiaraoct34.workers.dev/api/v1";
                        
                        const toggleBtns = document.querySelectorAll('.toggle-btn');
                        const panels = document.querySelectorAll('.form-panel');
                        
                        toggleBtns.forEach(btn => {
                            btn.addEventListener('click', () => {
                                const targetPanel = btn.dataset.panel;
                                
                                toggleBtns.forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                                
                                panels.forEach(p => p.classList.remove('active'));
                                document.getElementById(targetPanel + '-panel').classList.add('active');
                                
                                document.querySelectorAll('.message').forEach(m => m.style.display = 'none');
                            });
                        });
                        
                        function showMessage(elementId, text, type) {
                            const el = document.getElementById(elementId);
                            el.textContent = text;
                            el.className = 'message ' + type;
                            el.style.display = 'block';
                        }
                        
                        function hideMessage(elementId) {
                            document.getElementById(elementId).style.display = 'none';
                        }
                        
                        const loginForm = document.getElementById('loginForm');
                        const loginBtn = document.getElementById('loginBtn');
                        const loginEmailInput = document.getElementById('login-email');
                        const loginPasswordInput = document.getElementById('login-password');
                        
                        loginForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            hideMessage('login-message');
                            
                            const email = loginEmailInput.value.trim();
                            const password = loginPasswordInput.value;
                            
                            if (!email || !password) {
                                showMessage('login-message', 'Please fill in all fields', 'error');
                                return;
                            }
                            
                            loginBtn.disabled = true;
                            loginBtn.innerHTML = '<span class="loading"></span>';
                            loginEmailInput.disabled = true;
                            loginPasswordInput.disabled = true;
                            
                            try {
                                const response = await fetch(\`\${API_BASE_URL}/auth/login\`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    credentials: 'include',
                                    body: JSON.stringify({ email, password })
                                });
                                
                                const data = await response.json();
                                
                                if (response.ok && data.status === 'success') {
                                    localStorage.setItem('lustroom_jwt', data.access_token);
                                    localStorage.setItem('lustroom_jwt_expires_in', data.expires_in);
                                    localStorage.setItem('lustroom_jwt_obtained_at', Math.floor(Date.now() / 1000));
                                    localStorage.setItem('user_info', JSON.stringify(data.user));
                                    
                                    const profileResponse = await fetch(\`\${API_BASE_URL}/profile\`, {
                                        headers: { 'Authorization': \`Bearer \${data.access_token}\` }
                                    });
                                    
                                    const profileData = await profileResponse.json();
                                    
                                    if (profileResponse.ok && profileData.status === 'success') {
                                        localStorage.setItem('user_subscriptions', JSON.stringify(profileData.subscriptions || []));
                                        
                                        if (profileData.announcements) {
                                            localStorage.setItem('global_announcements', JSON.stringify(profileData.announcements));
                                        }
                                    }
                                    
                                    showMessage('login-message', 'âœ“ Login successful! Redirecting...', 'success');
                                    setTimeout(() => {
                                        window.location.href = 'links.html';
                                    }, 1000);
                                } else {
                                    throw new Error(data.message || 'Login failed');
                                }
                                
                            } catch (error) {
                                showMessage('login-message', error.message || 'An error occurred. Please try again.', 'error');
                                
                                loginBtn.disabled = false;
                                loginBtn.textContent = 'Log In';
                                loginEmailInput.disabled = false;
                                loginPasswordInput.disabled = false;
                            }
                        });
                        
                        const forgotForm = document.getElementById('forgotForm');
                        const forgotBtn = document.getElementById('forgotBtn');
                        const forgotEmailInput = document.getElementById('forgot-email');
                        
                        forgotForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            hideMessage('forgot-message');
                            
                            const email = forgotEmailInput.value.trim();
                            
                            if (!email) {
                                showMessage('forgot-message', 'Please enter your email address', 'error');
                                return;
                            }
                            
                            forgotBtn.disabled = true;
                            forgotBtn.innerHTML = '<span class="loading"></span>';
                            forgotEmailInput.disabled = true;
                            
                            try {
                                const response = await fetch(\`\${API_BASE_URL}/auth/forgot-password\`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ email })
                                });
                                
                                const data = await response.json();
                                
                                if (response.ok && data.status === 'success') {
                                    showMessage('forgot-message', 'âœ“ ' + data.message, 'success');
                                    forgotEmailInput.value = '';
                                } else {
                                    throw new Error(data.message || 'Request failed');
                                }
                                
                            } catch (error) {
                                showMessage('forgot-message', error.message || 'An error occurred. Please try again.', 'error');
                            } finally {
                                forgotBtn.disabled = false;
                                forgotBtn.textContent = 'Send Reset Link';
                                forgotEmailInput.disabled = false;
                            }
                        });
                    <\/script>
                </body>
                </html>
            `);
            document.close();
        }
    })();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>404 - Page Not Found</title>
    
    <!-- ðŸ”’ NUCLEAR GATE - HIDE EVERYTHING IMMEDIATELY -->
    <style>
        html, body {
            display: none !important;
            visibility: hidden !important;
        }
    </style>
    
    <!-- ========================================== -->
    <!-- ðŸ”’ TOKEN GATE - EXECUTES BEFORE EVERYTHING -->
    <!-- ========================================== -->
    <script>
    (function() {
        'use strict';
        
        const API_BASE_URL = "https://the-black-zenith-backend.onrender.com/api/v1";
        
        // ====================================
        // RATE LIMITING - Prevent brute force
        // ====================================
        function checkRateLimit() {
            const failedAttempts = parseInt(localStorage.getItem('failed_auth_attempts') || '0', 10);
            const lastAttempt = parseInt(localStorage.getItem('last_failed_attempt') || '0', 10);
            const timeSince = Date.now() - lastAttempt;
            const ONE_HOUR = 3600000;
            
            if (failedAttempts >= 5 && timeSince < ONE_HOUR) {
                const minutesRemaining = Math.ceil((ONE_HOUR - timeSince) / 60000);
                show404(true, minutesRemaining);
                return false;
            }
            
            return true;
        }
        
        function recordFailedAttempt() {
            const current = parseInt(localStorage.getItem('failed_auth_attempts') || '0', 10);
            localStorage.setItem('failed_auth_attempts', (current + 1).toString());
            localStorage.setItem('last_failed_attempt', Date.now().toString());
        }
        
        function clearFailedAttempts() {
            localStorage.removeItem('failed_auth_attempts');
            localStorage.removeItem('last_failed_attempt');
        }
        
        // ====================================
        // STEALTH 404 PAGE - Looks like GitHub Pages
        // ====================================
        function show404(rateLimited = false, minutesRemaining = 0) {
            const message = rateLimited 
                ? `<p style="color: #586069; font-size: 14px;">Too many requests. Please try again in ${minutesRemaining} minute${minutesRemaining > 1 ? 's' : ''}.</p>`
                : '<p style="color: #586069; font-size: 14px;">This is not the web page you are looking for.</p>';
            
            document.open();
            document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>404 - Page Not Found</title>
                    <style>
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                            margin: 0;
                            padding: 0;
                            background: #fff;
                        }
                        .container { 
                            max-width: 600px; 
                            margin: 0 auto; 
                            padding: 100px 40px; 
                            text-align: center; 
                        }
                        h1 { 
                            font-size: 48px; 
                            margin-bottom: 10px;
                            font-weight: 300;
                            color: #24292e;
                        }
                        p { 
                            color: #586069; 
                            font-size: 16px;
                            line-height: 1.5;
                        }
                        .logo {
                            width: 32px;
                            height: 32px;
                            margin-bottom: 20px;
                            opacity: 0.5;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <svg class="logo" height="32" viewBox="0 0 16 16" width="32" fill="#24292e">
                            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                        </svg>
                        <h1>404</h1>
                        ${message}
                    </div>
                </body>
                </html>
            `);
            document.close();
        }
        
        // Check rate limit first
        if (!checkRateLimit()) {
            return; // Already showing 404 with rate limit message
        }
        
        // Check if there's an access token in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('access_token');
        
        // If no token in URL, check if user already has a valid JWT session
        if (!accessToken) {
            const existingJWT = localStorage.getItem('lustroom_jwt');
            const obtainedAt = parseInt(localStorage.getItem('lustroom_jwt_obtained_at'), 10);
            const expiresIn = parseInt(localStorage.getItem('lustroom_jwt_expires_in'), 10);
            
            // If JWT exists and is still valid, redirect to main app
            if (existingJWT && obtainedAt && expiresIn) {
                const nowInSeconds = Math.floor(Date.now() / 1000);
                const isStillValid = (obtainedAt + expiresIn - 60) > nowInSeconds;
                
                if (isStillValid) {
                    // User has valid session, redirect to app
                    window.location.href = 'links.html';
                    return; // Stop execution
                }
            }
            
            // ðŸ”’ NUCLEAR OPTION: No token + No session = STEALTH 404
            show404();
            return;
        }
        
        // ====================================
        // TOKEN VALIDATION FLOW
        // ====================================
        
        // Show loading state
        function showLoading() {
            document.open();
            document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Validating Access...</title>
                    <style>
                        body { 
                            margin: 0; 
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            min-height: 100vh;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        }
                        .gate-container {
                            background: white;
                            padding: 40px;
                            border-radius: 12px;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                            text-align: center;
                            max-width: 400px;
                        }
                        .gate-spinner {
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #667eea;
                            border-radius: 50%;
                            width: 50px;
                            height: 50px;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 20px;
                        }
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                        .gate-title {
                            font-size: 24px;
                            font-weight: 600;
                            color: #333;
                            margin-bottom: 10px;
                        }
                        .gate-message {
                            color: #666;
                            font-size: 16px;
                        }
                    </style>
                </head>
                <body>
                    <div class="gate-container">
                        <div class="gate-spinner"></div>
                        <div class="gate-title">Validating Access</div>
                        <div class="gate-message">Please wait...</div>
                    </div>
                </body>
                </html>
            `);
            document.close();
        }
        
        // Show error (uses stealth 404)
        function showError() {
            recordFailedAttempt();
            show404();
        }
        
        // Start validation
        showLoading();
        
        // Validate token with backend
        fetch(`${API_BASE_URL}/auth/validate-token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token: accessToken })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Token validation failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success' && data.access_token) {
                // Store JWT session token
                localStorage.setItem('lustroom_jwt', data.access_token);
                localStorage.setItem('lustroom_jwt_expires_in', data.expires_in);
                localStorage.setItem('lustroom_jwt_obtained_at', Math.floor(Date.now() / 1000));
                localStorage.setItem('user_info', JSON.stringify(data.user_info));
                
                // Fetch profile data with subscriptions
                return fetch(`${API_BASE_URL}/profile`, {
                    headers: { 'Authorization': `Bearer ${data.access_token}` }
                });
            } else {
                throw new Error('Invalid response from server');
            }
        })
        .then(response => response.json())
        .then(profileData => {
            if (profileData.status === 'success') {
                // Store subscriptions and announcements
                localStorage.setItem('user_subscriptions', JSON.stringify(profileData.subscriptions || []));
                
                if (profileData.announcements) {
                    localStorage.setItem('global_announcements', JSON.stringify(profileData.announcements));
                } else {
                    localStorage.removeItem('global_announcements');
                }
                
                // Clear failed attempts on success
                clearFailedAttempts();
                
                // Success! Redirect to main app
                window.location.href = 'links.html';
            } else {
                throw new Error('Failed to load user profile');
            }
        })
        .catch(error => {
            console.error('Token validation error:', error);
            showError();
        });
    })();
    </script>
</head>
<body>
    <!-- This body content will NEVER render if the gate is working -->
    <!-- It only exists as a fallback for ancient browsers -->
    <div style="display:none;">
        <p>Loading...</p>
    </div>
</body>
</html>